{% extends "base.html" %}

{% block title %}Schienen Übersicht{% endblock %}

{% block content %}
<nav class="navbar bg-body-tertiary">
  <form class="container-fluid justify-content-start">
    <a href="{% url 'pit:info' %}" class="btn btn-sm btn-outline-secondary" type="button">Übersicht</a>
    <a href="{% url 'pit:course_table' %}" class="btn btn-sm btn-outline-secondary" type="button">Schienenlogistik</a>
  </form>
</nav>

<div class="container mt-5">
    <div class="mt-5 shadow">
        <h1 class="text-center">Schienen Übersicht</h1>
        <table class="table">
            <thead>
                <tr>
                    <th>Schiene</th>
                    <th>Aktueller Status</th>
                    <th>Nächster Schritt</th>
                    <th>Nächstes Datum</th>
                    <th>DPD Beauftragt</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for schiene_info in schienen_infos %}
                <tr id="schiene_row_{{ schiene_info.schiene.id }}">
                    <td>{{ schiene_info.schiene }}</td>
                    <td>{{ schiene_info.aktueller_status }}</td>
                    <td>{{ schiene_info.naechster_schritt }}</td>
                    <td>{{ schiene_info.naechstes_datum }}</td>
                    <td>
                        <input type="checkbox" id="dpd_beauftragt_{{ schiene_info.schiene.id }}" {% if schiene_info.dpd_beauftragt %} checked {% endif %}>
                    </td>
                    <td>
                        <button type="button" class="btn btn-success" onclick="schieneZurueck({{ schiene_info.schiene.id }})" id="zurueck_{{ schiene_info.schiene.id }}">Zurück</button>
                        <button type="button" class="btn btn-warning" onclick="schieneWeiterleitenNeu({{ schiene_info.schiene.id }})" id="weiterleiten_{{ schiene_info.schiene.id }}">Weiterleiten</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function schieneWeiterleitenNeu(schieneId) {
    const kundeId = document.getElementById("kunde").value;
    const weiterleitungsDatum = document.getElementById("weiterleitungsDatum").value;
    const rueckholungsDatum = document.getElementById("rueckholungDatum").value;

    fetch('/pfad/zur/schiene_weiterleiten_neu/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            schiene_id: schieneId,
            kunde_id: kundeId,
            weiterleitungs_datum: weiterleitungsDatum,
            rueckholungs_datum: rueckholungsDatum
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert('Fehler: ' + data.message);
        }
    });
}
</script>
{% endblock %}
